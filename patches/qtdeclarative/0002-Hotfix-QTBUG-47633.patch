From 1f16003521c654403df2d0b4b0618641ce769c1b Mon Sep 17 00:00:00 2001
From: Richard Weickelt <richard@weickelt.de>
Date: Mon, 29 Apr 2019 17:14:44 +0200
Subject: [PATCH 2/2] Hotfix QTBUG-47633

Change-Id: I113200b54ab8968b192ca6468042a0cbf1ce4b2f
---
 src/qml/qml/qqmlcomponent.cpp | 17 +++--------------
 src/qml/qml/qqmlcomponent_p.h |  3 +--
 2 files changed, 4 insertions(+), 16 deletions(-)

diff --git a/src/qml/qml/qqmlcomponent.cpp b/src/qml/qml/qqmlcomponent.cpp
index 14ae52f..e2f07c6 100644
--- a/src/qml/qml/qqmlcomponent.cpp
+++ b/src/qml/qml/qqmlcomponent.cpp
@@ -849,13 +849,10 @@ QQmlComponentPrivate::beginCreate(QQmlContextData *context)
 
     // Do not create infinite recursion in object creation
     static const int maxCreationDepth = 10;
-    if (++creationDepth.localData() >= maxCreationDepth) {
+    if (creationDepth.localData() >= maxCreationDepth) {
         qWarning("QQmlComponent: Component creation is recursing - aborting");
-        --creationDepth.localData();
-        return 0;
+        return nullptr;
     }
-    Q_ASSERT(creationDepth.localData() >= 1);
-    depthIncreased = true;
 
     QQmlEnginePrivate *enginePriv = QQmlEnginePrivate::get(engine);
 
@@ -879,10 +876,6 @@ QQmlComponentPrivate::beginCreate(QQmlContextData *context)
         ddata->indestructible = true;
         ddata->explicitIndestructibleSet = true;
         ddata->rootObjectInCreation = false;
-    } else {
-        Q_ASSERT(creationDepth.localData() >= 1);
-        --creationDepth.localData();
-        depthIncreased = false;
     }
 
     return rv;
@@ -958,14 +951,10 @@ void QQmlComponentPrivate::completeCreate()
 {
     QMutexLocker lock(&mutex);
     if (state.completePending) {
+        ++creationDepth.localData();
         QQmlEnginePrivate *ep = QQmlEnginePrivate::get(engine);
         complete(ep, &state);
-    }
-
-    if (depthIncreased) {
-        Q_ASSERT(creationDepth.localData() >= 1);
         --creationDepth.localData();
-        depthIncreased = false;
     }
 }
 
diff --git a/src/qml/qml/qqmlcomponent_p.h b/src/qml/qml/qqmlcomponent_p.h
index 2a57f7b..c1aee6c 100644
--- a/src/qml/qml/qqmlcomponent_p.h
+++ b/src/qml/qml/qqmlcomponent_p.h
@@ -79,7 +79,7 @@ class Q_QML_PRIVATE_EXPORT QQmlComponentPrivate : public QObjectPrivate, public
 
 public:
     QQmlComponentPrivate()
-        : typeData(0), progress(0.), start(-1), engine(0), creationContext(0), depthIncreased(false) {}
+        : typeData(0), progress(0.), start(-1), engine(0), creationContext(0) {}
 
     void loadUrl(const QUrl &newUrl, QQmlComponent::CompilationMode mode = QQmlComponent::PreferSynchronous);
 
@@ -129,7 +129,6 @@ public:
 
     QQmlEngine *engine;
     QQmlGuardedContextData creationContext;
-    bool depthIncreased;
 
     void clear();
 
-- 
2.7.4

